{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% load render_table from django_tables2 %}

{% block title %}{% trans "Program" %}{% endblock %}


{% block content %}

    Editing Program: <code>{{ program_info.name }}</code> <br/><br/>


    <table class="table table-hover">
        <thead>
        <tr>
            <td>{% trans 'Line' %}</td>
            <td>{% trans 'Pin' %}</td>
            <td>{% trans 'Type' %}</td>
            <td>{% trans 'Data' %}</td>
            <td>{% trans 'Next sucess' %}</td>
            <td>{% trans 'Next fail' %}</td>
        </tr>
        </thead>

        {% for step in program_steps %}
            <tr>
                <td hidden>
                    {{ step.pk }}
                </td>
                <td>
                    <code>{{ step.num }}</code>
                </td>
                <td>
                    <select class="form-control">
                        <option value="output"
                                {% if step.type == 'output' %}selected{% endif %}>{% trans 'Output' %}</option>
                        <option value="sleep"
                                {% if step.type == 'sleep' %}selected{% endif %}>{% trans 'Sleep' %}</option>
                    </select>
                </td>
                <td>
                    <input class="form-control" type="number" size="4" value="{{ step.pin }}">
                </td>

                <td>
                    <input class="form-control" value="{{ step.data }}">
                </td>
                <td>
                    <input class="form-control" type="number" size="4" value="{{ step.successor_true }}">
                </td>
                <td>
                    <input class="form-control" type="number" size="4" value="{{ step.successor_false }}">
                </td>
            </tr>
        {% endfor %}
    </table>




{% endblock %}


{% block script %}
    <script type="text/javascript">
        function setPin(pin, state) {
            let request_body = JSON.stringify({
                "pin": pin,
                "mode": 1,
                "state": state
            });

            makeRequest(request_body, '{% url "api_save_step" %}' )
        }

        function runProgram(program) {
            let request_body = JSON.stringify({
                "program": program
            });

            makeRequest(request_body, '{% url "api_run_prog" %}' )
        }

        // TODO make general method in base
        function makeRequest(request_body, url) {
            $.ajax({
                url: url,
                dataType: 'json',
                type: 'POST',
                contentType: 'application/json',
                data: request_body,
                success: function (data, textStatus, jQxhr) {
                    console.log(data, textStatus, jQxhr);
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    console.log(errorThrown);
                }
            });
        }

    </script>
{% endblock %}